<!DOCTYPE html>

<html lang="en">
  <head>
    <title>This is gyropage</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  </head>
  <body>
    <textarea id="test"></textarea>
    <br />
    <label id="text">This is Gyro Page</label>
    <br />
    <br />

    <div class="panel panel-success">
        <div class="panel-heading">Your current หมุนๆ</div>
        <div class="panel-body">
            <br />
            <label id="currentGyro"> </label>
            <br />
            <br />
        </div>
    </div>


    <div class="panel panel-info">
        <div class="panel-heading">What is Humidity?</div>
        <div class="panel-body">
        </div>
    </div>

    <div class="panel panel-warning">
      <div>
        <button onclick = giveSuggestion();>Show Suggestion</button> <br />
      </div>
        <div class="panel-heading">Suggestion</div>
        <div class="panel-body">
            <label id="suggestion"> </label>
        </div>
    </div>

    <div class="panel panel-danger">
      <div class="panel-heading">History of info</div>
        <div class="panel-body">
          <textarea id="history"></textarea>
        </div>
    </div>

  <script type="text/javascript">
  var currentMessage = '';
  var currentGyroLabel = $("#currentGyro");
  var suggestionLabel = $("#suggestion");
  var lbl = '';
  var gyroAndDateArr = [];

  setInterval(function() {
    $.ajax({
      url: 'http://10.32.176.4/HP'
    })
    .done(function(data) {
      if (data !== currentMessage) {
        console.log(data)
        checkInput(data);
        currentMessage = data;
      }
    })
  }, 1000);

  function checkInput(input) {
    var inputArr = input.split(",");
    if (inputArr[0] == 5)
      recieveGyro(inputArr[1]);
  }

  function recieveGyro(gyroData) {
    var axisArr = gyroData.split("(");
    date = new Date();
    x = axisArr[0];
    y = axisArr[1];
    z = axisArr[2];
    var gyroTime = date.toLocaleTimeString() + ' ' + date.toDateString();
    gyroAndDateArr.push([x, y, z, gyroTime]);
    var gyroStr = 'x: ' + x + ' y: ' + y + ' z: ' + z;
    currentGyroLabel.text(gyroStr) ;
    updateHistory(gyroStr + ' ' + gyroTime)
  }

  function giveSuggestion() {
      var averageGyro = findAverage();
      if(Number.isNaN(averageGyro))
        suggestionLabel.text('No information');
      else
        suggestionLabel.text('หัวกลิ้งหมุนๆ') ;
  }

  function findAverage() {
    var sumX = 0;
    var sumY = 0;
    var sumZ = 0;

    for(var i = 0; i < gyroAndDateArr.length; i++) {
      sumX += parseInt(gyroAndDateArr[i][0]);
    }
    var avrX = sumX / gyroAndDateArr.length;

    for(var i = 0; i < gyroAndDateArr.length; i++) {
      sumY += parseInt(gyroAndDateArr[i][1]);
    }
    var avrY = sumY / gyroAndDateArr.length;

    for(var i = 0; i < gyroAndDateArr.length; i++) {
      sumZ += parseInt(gyroAndDateArr[i][2]);
    }
    var avrZ = sumZ / gyroAndDateArr.length;

    return [avrX, avrY, avrZ];
  }

  function updateHistory(valuesAndDate) {
      var oldText= $('#history').val();
      $('#history').html(oldText + '\n' + valuesAndDate);
  }
  </script
  </body>
</html>
